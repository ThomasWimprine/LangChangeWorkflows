# Default Quality Thresholds for PRP Workflows
# These are the MANDATORY quality standards that CANNOT be lowered
# Per CLAUDE.md: "These thresholds are non-negotiable for life-critical development"

version: "1.0"

# Test Coverage Thresholds
coverage:
  lines: 100                        # 100% line coverage MANDATORY
  branches: 100                     # 100% branch coverage MANDATORY
  functions: 100                    # 100% function coverage MANDATORY
  statements: 100                   # 100% statement coverage MANDATORY

  # Coverage must include ALL files
  exclude_patterns: []              # NO exclusions allowed

  # Enforcement
  fail_under: 100                   # Build fails if < 100%
  bypass_allowed: false             # NO bypass mechanism

# Mutation Testing Thresholds
mutation:
  score_minimum: 95                 # â‰¥95% mutation score required
  timeout_per_test: 10              # 10 seconds per mutant

  # Mutation operators
  operators:
    - "arithmetic"                  # +, -, *, /, %
    - "comparison"                  # <, >, <=, >=, ==, !=
    - "logical"                     # and, or, not
    - "assignment"                  # =, +=, -=, *=, /=
    - "return_values"               # Return value mutations

  # Enforcement
  fail_under: 95
  bypass_allowed: false

# Mock Detection Thresholds
mocks:
  production_directories:
    - "src/"
    - "lib/"
    - "app/"

  test_directories:
    - "tests/"
    - "test/"
    - "spec/"
    - "__tests__/"

  # Zero tolerance for mocks in production
  max_mocks_in_production: 0

  # Blocked patterns
  blocked_imports:
    - "unittest.mock"
    - "mock.Mock"
    - "pytest.mock"
    - "jest.mock"
    - "sinon"

  blocked_calls:
    - "Mock("
    - "MagicMock("
    - "patch("
    - "mock("
    - "stub("
    - "spy("

  # Enforcement
  fail_on_detection: true
  bypass_allowed: false

# Security Thresholds
security:
  # Severity levels that block merge
  blocking_severities:
    - "critical"
    - "high"

  # Allowed (must still be documented)
  allowed_severities:
    - "medium"
    - "low"
    - "informational"

  # Maximum allowed issues by severity
  max_issues:
    critical: 0
    high: 0
    medium: 5                       # Must be documented with mitigation plan
    low: 10                         # Must be documented

  # Dependency scanning
  outdated_dependencies:
    max_major_versions_behind: 0    # Must be on latest major version
    max_minor_versions_behind: 2    # Can be up to 2 minor versions behind
    security_updates_required: true # Security updates are MANDATORY

  # Enforcement
  fail_on_critical_or_high: true
  bypass_allowed: false

# Production-Ready Thresholds
production_ready:
  # Stub detection
  stubs:
    max_stubs_allowed: 0
    blocked_patterns:
      - "pass"
      - "NotImplementedError"
      - "TODO:"
      - "FIXME:"
      - "raise NotImplementedError"
      - "return None  # stub"

  # Error handling
  error_handling:
    min_coverage_percentage: 100    # 100% of external calls wrapped
    required_exception_types:
      - "Exception"                 # Catch specific exceptions
      - "ValueError"
      - "TypeError"
      - "IOError"
    meaningful_error_messages: true # Error messages must be descriptive

  # Logging
  logging:
    min_coverage_percentage: 80     # 80% of functions have logging
    required_log_levels:
      - "ERROR"                     # All errors logged
      - "WARNING"                   # Warnings logged
      - "INFO"                      # Key operations logged
    structured_logging: true        # JSON structured logs required

  # TODO/FIXME resolution
  todos:
    max_unresolved: 0
    allowed_with_issue_number: true # "TODO(#123): ..." is allowed

  # Completeness score
  completeness:
    min_score: 100                  # Perfect score required
    scoring:
      no_stubs: 30                  # 30 points
      error_handling: 25            # 25 points
      logging: 20                   # 20 points
      no_todos: 15                  # 15 points
      test_coverage: 10             # 10 points (validated by Gate 2)

  # Enforcement
  fail_under: 100
  bypass_allowed: false

# TDD Cycle Verification Thresholds
tdd:
  # RED-GREEN-REFACTOR pattern enforcement
  require_red_before_green: true
  require_green_before_refactor: true

  # Commit message patterns
  red_commit_patterns:
    - "RED:"
    - "[RED]"
    - "test:"
    - "feat(test):"

  green_commit_patterns:
    - "GREEN:"
    - "[GREEN]"
    - "feat:"
    - "implement:"

  refactor_commit_patterns:
    - "REFACTOR:"
    - "[REFACTOR]"
    - "refactor:"
    - "chore(refactor):"

  # Enforcement
  strict_ordering: true             # RED must come before GREEN
  allow_skip_refactor: false        # REFACTOR is MANDATORY
  bypass_allowed: false

# Circuit Breaker Thresholds
circuit_breaker:
  # Consecutive failure threshold
  max_consecutive_failures: 15

  # Recovery
  reset_on_single_success: true     # One success resets counter
  manual_reset_required: false      # Auto-reset allowed

  # Escalation
  notify_on_activation: true
  require_human_intervention: true  # Human must approve continuation

  # Enforcement
  bypass_allowed: false

# Cost Optimization Targets
cost:
  # Target savings through optimization
  target_cost_reduction_percentage: 40  # 40% savings goal

  # Per-gate cost targets (USD)
  max_cost_per_gate:
    gate_1_tdd: 0.03
    gate_2_coverage: 0.05
    gate_3_mock: 0.02
    gate_4_mutation: 0.06
    gate_5_security: 0.05
    gate_6_production_ready: 0.04

  # Total workflow cost target
  max_cost_per_prp: 0.25            # $0.25 per PRP execution (optimized)

  # Cache performance targets
  cache_hit_rate_target: 60         # 60% cache hit rate goal

# Retry and Timeout Limits
limits:
  # Retry limits
  max_retries_per_gate: 3           # 3-strike rule
  max_retries_total: 15             # Total across all gates

  # Timeouts
  timeouts:
    gate_validation: 600            # 10 minutes per gate
    specialist_consultation: 300    # 5 minutes for specialist
    total_workflow: 3600            # 1 hour total workflow timeout

  # Rate limits
  api_calls:
    max_per_minute: 60
    max_per_hour: 1000
    max_per_day: 10000

# Override Policy
overrides:
  # Thresholds that can be overridden per-project
  overridable_thresholds:
    - "mutation.score_minimum"      # Can be raised, not lowered
    - "security.max_issues.medium"  # Can be lowered with justification
    - "production_ready.logging.min_coverage_percentage"  # Can be adjusted

  # Thresholds that CANNOT be overridden
  non_overridable_thresholds:
    - "coverage.*"                  # 100% coverage is MANDATORY
    - "mocks.max_mocks_in_production"  # Zero mocks is MANDATORY
    - "security.blocking_severities"   # Critical/High block is MANDATORY
    - "production_ready.stubs.max_stubs_allowed"  # Zero stubs is MANDATORY
    - "circuit_breaker.max_consecutive_failures"  # 15 failures is MANDATORY

  # Override approval process
  override_requires:
    - "2_of_3_maintainer_approval"
    - "documented_justification"
    - "risk_assessment"
    - "retroactive_prp"

# Compliance Standards
compliance:
  # Mandatory compliance frameworks
  frameworks:
    - "NIST Cybersecurity Framework"
    - "NIST 800-53 (Moderate Impact)"
    - "NIST 800-218 (Secure SDLC)"
    - "NIST 800-122 (PII Protection)"

  # Privacy standards
  privacy:
    - "NIST Privacy Framework"
    - "GDPR compliance (if applicable)"
    - "CCPA compliance (if applicable)"

  # Audit requirements
  audit:
    maintain_complete_trail: true
    log_all_decisions: true
    track_all_overrides: true
