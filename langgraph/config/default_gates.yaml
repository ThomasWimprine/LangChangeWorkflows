# Default Gate Configuration for PRP Workflows
# This configuration is deployed to ~/.claude/langgraph/config/default_gates.yaml
# Projects can override by creating .claude/langgraph/config/gates.yaml

version: "1.0"

# Global Settings
global:
  max_retries: 3                    # Maximum retries per gate (3-strike rule)
  circuit_breaker_threshold: 15     # Consecutive failures before circuit breaker
  enable_context_optimization: true # Enable cost-saving context sharing
  enable_checkpointing: true        # Enable state persistence

# Gate Definitions
gates:
  # Gate 1: TDD Cycle Verification
  gate_1_tdd:
    enabled: true
    blocking: true                  # Must pass to continue
    name: "TDD Cycle Verification"
    description: "Verifies RED-GREEN-REFACTOR pattern in commit history"
    validation_method: "git_history_analysis"
    specialist_agent: "test-automation"
    cost_estimate_tokens: 1500

  # Gate 2: Test Coverage (Phase 0 POC)
  gate_2_coverage:
    enabled: true
    blocking: true
    name: "Test Coverage"
    description: "Validates 100% test coverage (lines, branches, functions, statements)"
    validation_method: "pytest_cov"
    threshold: 100                  # Coverage percentage required
    specialist_agent: "test-automation"
    cost_estimate_tokens: 2000
    cache_ttl_minutes: 5

  # Gate 3: Mock Detection
  gate_3_mock:
    enabled: true
    blocking: true
    name: "Mock Detection"
    description: "Ensures zero mocks/stubs/test doubles in production code (src/)"
    validation_method: "static_analysis"
    allowed_directories:
      - "tests/"
      - "test/"
      - "spec/"
    blocked_patterns:
      - "Mock"
      - "Stub"
      - "Fake"
      - "Spy"
      - "mock("
      - "patch("
    specialist_agent: "python-developer"  # Language-specific
    cost_estimate_tokens: 1000

  # Gate 4: Mutation Testing
  gate_4_mutation:
    enabled: true
    blocking: true
    name: "Mutation Testing"
    description: "Validates mutation score â‰¥95% to ensure test effectiveness"
    validation_method: "mutation_testing"
    threshold: 95                   # Mutation score percentage
    specialist_agent: "test-automation"
    cost_estimate_tokens: 3000
    timeout_seconds: 600            # 10 minutes for mutation testing

  # Gate 5: Security Validation
  gate_5_security:
    enabled: true
    blocking: true
    name: "Security Validation"
    description: "Scans for critical/high vulnerabilities and security issues"
    validation_method: "security_scan"
    allowed_severity_levels:
      - "low"
      - "informational"
    blocked_severity_levels:
      - "critical"
      - "high"
    scan_tools:
      - "bandit"         # Python security scanner
      - "safety"         # Python dependency scanner
      - "semgrep"        # Multi-language static analysis
    specialist_agent: "security-reviewer"
    cost_estimate_tokens: 2500

  # Gate 6: Production-Ready Standards
  gate_6_production_ready:
    enabled: true
    blocking: true
    name: "Production-Ready Standards"
    description: "Validates completeness: no stubs, full error handling, comprehensive logging"
    validation_method: "production_ready_scan"
    checks:
      - "no_stub_implementations"
      - "complete_error_handling"
      - "structured_logging"
      - "no_unresolved_todos"
    completeness_threshold: 100     # Perfect score required
    specialist_agent: "architect-reviewer"
    cost_estimate_tokens: 2000

# Failure Handling Configuration
failure_handling:
  # 3-Strike Rule
  retry_strategy: "exponential_backoff"
  initial_retry_delay_seconds: 5
  max_retry_delay_seconds: 60
  backoff_multiplier: 2.0

  # Specialist Consultation
  consult_after_failures: 3         # Consult specialist after 3 failures
  specialist_timeout_seconds: 300   # 5 minutes for specialist response

  # Circuit Breaker
  circuit_breaker:
    enabled: true
    threshold: 15                   # Consecutive failures
    reset_after_success: true       # Reset counter on any successful gate
    manual_intervention_required: true

# Cost Optimization
cost_optimization:
  enable_context_sharing: true
  enable_result_caching: true
  cache_ttl:
    coverage_results: 300           # 5 minutes
    agent_responses: 600            # 10 minutes
    file_contents: 900              # 15 minutes

  # Estimated costs (USD) per gate with optimization
  estimated_costs:
    gate_1_tdd: 0.02
    gate_2_coverage: 0.03
    gate_3_mock: 0.015
    gate_4_mutation: 0.045
    gate_5_security: 0.0375
    gate_6_production_ready: 0.03
    total_per_prp: 0.1725           # ~40% savings vs non-optimized

# Monitoring and Metrics
monitoring:
  track_cost_savings: true
  track_cache_hit_rate: true
  track_gate_pass_rates: true
  track_specialist_effectiveness: true
  export_metrics_format: "json"
  metrics_output_path: ".langgraph/metrics/"
