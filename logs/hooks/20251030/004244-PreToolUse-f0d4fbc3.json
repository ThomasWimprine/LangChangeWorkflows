{"session_id":"f0d4fbc3-a5b1-443e-8264-7550e32cfe6a","transcript_path":"/home/thomas/.claude/projects/-home-thomas-Repositories-LangChangeWorkflows/f0d4fbc3-a5b1-443e-8264-7550e32cfe6a.jsonl","cwd":"/home/thomas/Repositories/LangChangeWorkflows","permission_mode":"acceptEdits","hook_event_name":"PreToolUse","tool_name":"Write","tool_input":{"file_path":"/home/thomas/Repositories/LangChangeWorkflows/examples/auto_detect_runner.py","content":"#!/usr/bin/env python3\n\"\"\"\nAuto-Detect Project Type Runner\n\nThis script automatically detects your project type (Node, Go, Python, Terraform, etc.)\nand runs the appropriate PRP workflow.\n\nUsage:\n    cd /path/to/your/project\n    python3 ~/Repositories/LangChangeWorkflows/examples/auto_detect_runner.py\n\nOr specify project path:\n    python3 ~/Repositories/LangChangeWorkflows/examples/auto_detect_runner.py --project /path/to/project\n\"\"\"\n\nimport sys\nimport os\nimport argparse\nfrom pathlib import Path\nfrom dotenv import load_dotenv\n\n# Add parent directory to path\nsys.path.insert(0, str(Path(__file__).parent.parent))\n\nfrom prp_langgraph.workflows.base_prp_workflow import BasePRPWorkflow\n\n\ndef detect_project_type(project_path: Path) -> dict:\n    \"\"\"\n    Auto-detect project type based on files and directory structure.\n\n    Returns dict with:\n        - type: \"nodejs\", \"go\", \"python\", \"terraform\", etc.\n        - language: detected language\n        - source_dirs: list of source directories found\n        - test_dirs: list of test directories found\n        - config_hint: which config file to use\n    \"\"\"\n\n    # Check for project indicator files\n    indicators = {\n        \"nodejs\": [\"package.json\", \"package-lock.json\", \"yarn.lock\", \"pnpm-lock.yaml\"],\n        \"python\": [\"setup.py\", \"pyproject.toml\", \"requirements.txt\", \"Pipfile\"],\n        \"go\": [\"go.mod\", \"go.sum\"],\n        \"terraform\": [\"*.tf\", \"terraform.tfvars\"],\n        \"rust\": [\"Cargo.toml\", \"Cargo.lock\"],\n        \"java\": [\"pom.xml\", \"build.gradle\", \"build.gradle.kts\"],\n    }\n\n    detected_type = None\n\n    for proj_type, files in indicators.items():\n        for indicator in files:\n            if \"*\" in indicator:\n                # Glob pattern\n                if list(project_path.glob(indicator)):\n                    detected_type = proj_type\n                    break\n            else:\n                if (project_path / indicator).exists():\n                    detected_type = proj_type\n                    break\n        if detected_type:\n            break\n\n    if not detected_type:\n        detected_type = \"unknown\"\n\n    # Detect source directories\n    common_source_dirs = {\n        \"nodejs\": [\"src\", \"lib\", \"dist\"],\n        \"python\": [\"src\", \"lib\", \"app\"],\n        \"go\": [\"cmd\", \"internal\", \"pkg\", \"api\"],\n        \"terraform\": [\"modules\", \"environments\"],\n        \"rust\": [\"src\"],\n        \"java\": [\"src/main/java\", \"src\"],\n    }\n\n    source_dirs = []\n    for dirname in common_source_dirs.get(detected_type, [\"src\", \"lib\"]):\n        if (project_path / dirname).exists():\n            source_dirs.append(dirname)\n\n    # Detect test directories\n    common_test_dirs = {\n        \"nodejs\": [\"tests\", \"test\", \"__tests__\", \"spec\"],\n        \"python\": [\"tests\", \"test\"],\n        \"go\": [],  # Go tests are inline\n        \"terraform\": [\"tests\", \"test\", \"examples\"],\n        \"rust\": [\"tests\"],\n        \"java\": [\"src/test/java\", \"test\"],\n    }\n\n    test_dirs = []\n    for dirname in common_test_dirs.get(detected_type, [\"tests\", \"test\"]):\n        if (project_path / dirname).exists():\n            test_dirs.append(dirname)\n\n    # For Go, check for *_test.go files\n    if detected_type == \"go\":\n        if list(project_path.rglob(\"*_test.go\")):\n            test_dirs.append(\"*_test.go (inline)\")\n\n    return {\n        \"type\": detected_type,\n        \"language\": detected_type,  # Could be refined\n        \"source_dirs\": source_dirs,\n        \"test_dirs\": test_dirs,\n        \"config_hint\": f\"examples/project_configs/{detected_type}_project.yaml\"\n    }\n\n\ndef main():\n    parser = argparse.ArgumentParser(description=\"Auto-detect project type and run PRP workflow\")\n    parser.add_argument(\n        \"--project\",\n        default=\".\",\n        help=\"Project directory path (default: current directory)\"\n    )\n    parser.add_argument(\n        \"--prp-file\",\n        default=\"prp/idea.md\",\n        help=\"PRP file to execute (default: prp/idea.md)\"\n    )\n    args = parser.parse_args()\n\n    # Load environment\n    load_dotenv()\n\n    # Resolve project path\n    project_path = Path(args.project).resolve()\n\n    if not project_path.exists():\n        print(f\"Error: Project path does not exist: {project_path}\")\n        return 1\n\n    print(\"=\" * 70)\n    print(\" LangGraph PRP Workflow - Auto-Detect Runner\")\n    print(\"=\" * 70)\n    print()\n\n    # Detect project type\n    print(\"Detecting project type...\")\n    detection = detect_project_type(project_path)\n\n    print(f\"  Type: {detection['type'].upper()}\")\n    print(f\"  Source directories: {', '.join(detection['source_dirs']) if detection['source_dirs'] else 'None found'}\")\n    print(f\"  Test directories: {', '.join(detection['test_dirs']) if detection['test_dirs'] else 'None found'}\")\n    print()\n\n    if detection['type'] == 'unknown':\n        print(\"⚠ Warning: Could not auto-detect project type\")\n        print(\"  The workflow will use default Python configuration\")\n        print()\n    else:\n        config_file = Path(__file__).parent.parent / detection['config_hint']\n        if config_file.exists():\n            print(f\"ℹ Hint: Project-specific config available at:\")\n            print(f\"  {detection['config_hint']}\")\n            print(f\"  Copy to your project as: .langgraph/config/gates.yaml\")\n            print()\n\n    # Check for tests\n    if not detection['test_dirs']:\n        print(\"⚠ Warning: No test directories detected!\")\n        print(\"  Gate 2 (Coverage) requires tests to validate\")\n        print(f\"  Create a '{['tests', 'test'][0]}/' directory with tests\")\n        print()\n\n        response = input(\"Continue anyway? (y/N): \").strip().lower()\n        if response != 'y':\n            print(\"Aborted.\")\n            return 0\n        print()\n\n    # Initialize workflow\n    print(\"Initializing workflow...\")\n    workflow = BasePRPWorkflow(\n        enable_checkpointing=True,\n        enable_context_optimization=True\n    )\n    print(\"✓ Workflow initialized\")\n    print()\n\n    # Execute workflow\n    print(\"Starting PRP execution...\")\n    print(\"-\" * 70)\n\n    try:\n        result = workflow.execute(\n            prp_file=args.prp_file,\n            initial_state={\n                \"project_path\": str(project_path),\n                \"project_name\": project_path.name,\n                \"project_type\": detection['type'],\n                \"source_directories\": detection['source_dirs'],\n                \"test_directories\": detection['test_dirs']\n            }\n        )\n\n        print(\"-\" * 70)\n        print()\n\n        # Display results\n        status = result.get(\"workflow_status\", \"unknown\")\n\n        print(\"Results:\")\n        print(\"=\" * 70)\n        print(f\"Status: {status.upper()}\")\n        print()\n\n        if status == \"completed\":\n            print(\"✓ SUCCESS - All gates passed!\")\n            gates_passed = result.get(\"gates_passed\", [])\n            print(f\"  Gates passed: {', '.join(gates_passed)}\")\n        else:\n            print(\"✗ FAILED - Workflow did not complete\")\n            print(f\"  Reason: {result.get('failure_reason', 'unknown')}\")\n\n        print()\n        print(f\"Cost: ${sum(result.get('cost_tracking', {}).values()):.4f}\")\n        print(f\"API Calls: {result.get('api_calls', 0)}\")\n        print(f\"Cache Hits: {result.get('cache_hits', 0)}\")\n        print(\"=\" * 70)\n\n        return 0 if status == \"completed\" else 1\n\n    except KeyboardInterrupt:\n        print(\"\\n\\n⚠ Workflow interrupted by user\")\n        return 130\n    except Exception as e:\n        print(f\"\\n\\n✗ ERROR: {e}\")\n        import traceback\n        traceback.print_exc()\n        return 1\n\n\nif __name__ == \"__main__\":\n    sys.exit(main())\n"}}
