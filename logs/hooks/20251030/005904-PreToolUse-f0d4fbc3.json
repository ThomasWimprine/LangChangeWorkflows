{"session_id":"f0d4fbc3-a5b1-443e-8264-7550e32cfe6a","transcript_path":"/home/thomas/.claude/projects/-home-thomas-Repositories-LangChangeWorkflows/f0d4fbc3-a5b1-443e-8264-7550e32cfe6a.jsonl","cwd":"/home/thomas/Repositories/LangChangeWorkflows","permission_mode":"acceptEdits","hook_event_name":"PreToolUse","tool_name":"Write","tool_input":{"file_path":"/home/thomas/Repositories/LangChangeWorkflows/examples/learning/interactive_walkthrough.py","content":"#!/usr/bin/env python3\n\"\"\"\nInteractive LangGraph Walkthrough\n==================================\n\nThis script provides a hands-on, step-by-step exploration of how the LangGraph\nPRP workflow executes. You'll see:\n\n- State evolution at each node\n- Real-time cost tracking\n- Context optimization in action\n- Retry logic and failure handling\n\nUsage:\n    python3 examples/learning/interactive_walkthrough.py\n\nControls:\n    ENTER = Continue to next step\n    's' = Show full state\n    'c' = Show cost breakdown\n    'q' = Quit\n\"\"\"\n\nimport sys\nimport os\nimport json\nfrom pathlib import Path\nfrom typing import Dict, Any\nimport time\n\n# Add parent directory to path\nsys.path.insert(0, str(Path(__file__).parent.parent.parent))\n\nfrom prp_langgraph.workflows.base_prp_workflow import BasePRPWorkflow\nfrom prp_langgraph.schemas.prp_state import PRPState\n\n\nclass InteractiveWorkflow(BasePRPWorkflow):\n    \"\"\"\n    Extended workflow with interactive step-through capabilities.\n    \"\"\"\n\n    def __init__(self):\n        super().__init__(enable_checkpointing=False, enable_context_optimization=True)\n        self.step_count = 0\n        self.paused = True\n\n    def pause_for_user(self, message: str, state: PRPState):\n        \"\"\"\n        Pause execution and show current state to user.\n        \"\"\"\n        self.step_count += 1\n\n        print(\"\\n\" + \"=\" * 70)\n        print(f\"STEP {self.step_count}: {message}\")\n        print(\"=\" * 70)\n\n        # Show key state information\n        print(\"\\nüìä Current State Snapshot:\")\n        print(f\"  Workflow ID: {state.get('workflow_id', 'N/A')}\")\n        print(f\"  Current Gate: {state.get('current_gate', 'N/A')}\")\n        print(f\"  Gates Passed: {len(state.get('gates_passed', []))}\")\n        print(f\"  Gates Failed: {len(state.get('gates_failed', {}))}\")\n        print(f\"  Consecutive Failures: {state.get('consecutive_failures', 0)}\")\n        print(f\"  Circuit Breaker: {'üî¥ ACTIVE' if state.get('circuit_breaker_active') else 'üü¢ OK'}\")\n\n        # Show cost tracking\n        costs = state.get('cost_tracking', {})\n        total_cost = sum(costs.values())\n        print(f\"\\nüí∞ Cost Tracking:\")\n        print(f\"  Total Cost: ${total_cost:.4f}\")\n        if costs:\n            for gate, cost in costs.items():\n                print(f\"    {gate}: ${cost:.4f}\")\n\n        # Show cache stats if available\n        if hasattr(self, 'context_optimizer'):\n            stats = self.context_optimizer.get_cache_stats()\n            print(f\"\\nüì¶ Cache Performance:\")\n            print(f\"  Cache Hits: {stats['cache_hits']}\")\n            print(f\"  Cache Misses: {stats['cache_misses']}\")\n            print(f\"  Hit Rate: {stats['hit_rate_percentage']:.1f}%\")\n            print(f\"  Estimated Savings: ${stats.get('estimated_savings_usd', 0):.4f}\")\n\n        # Wait for user input\n        print(\"\\n\" + \"-\" * 70)\n        print(\"Commands: [ENTER]=continue | [s]=show full state | [c]=cost detail | [q]=quit\")\n        print(\"-\" * 70)\n\n        while True:\n            user_input = input(\"\\n> \").strip().lower()\n\n            if user_input == 'q':\n                print(\"\\nüëã Exiting interactive walkthrough...\")\n                sys.exit(0)\n            elif user_input == 's':\n                self._show_full_state(state)\n            elif user_input == 'c':\n                self._show_cost_detail(state)\n            elif user_input == '' or user_input == 'enter':\n                break\n            else:\n                print(\"Unknown command. Use ENTER to continue, 's' for state, 'c' for costs, 'q' to quit.\")\n\n    def _show_full_state(self, state: PRPState):\n        \"\"\"Show complete state object.\"\"\"\n        print(\"\\n\" + \"=\" * 70)\n        print(\"FULL STATE OBJECT\")\n        print(\"=\" * 70)\n        print(json.dumps(dict(state), indent=2, default=str))\n        print(\"=\" * 70)\n\n    def _show_cost_detail(self, state: PRPState):\n        \"\"\"Show detailed cost breakdown.\"\"\"\n        print(\"\\n\" + \"=\" * 70)\n        print(\"COST BREAKDOWN\")\n        print(\"=\" * 70)\n\n        costs = state.get('cost_tracking', {})\n        total_cost = sum(costs.values())\n\n        if not costs:\n            print(\"  No costs recorded yet\")\n        else:\n            for gate, cost in costs.items():\n                percentage = (cost / total_cost * 100) if total_cost > 0 else 0\n                print(f\"  {gate}:\")\n                print(f\"    Cost: ${cost:.4f}\")\n                print(f\"    Percentage: {percentage:.1f}%\")\n\n            print(f\"\\n  Total: ${total_cost:.4f}\")\n\n        # Show cache savings\n        if hasattr(self, 'context_optimizer'):\n            stats = self.context_optimizer.get_cache_stats()\n            savings = stats.get('estimated_savings_usd', 0)\n            if savings > 0:\n                print(f\"\\n  Cache Savings: ${savings:.4f}\")\n                print(f\"  Effective Cost: ${total_cost - savings:.4f}\")\n                print(f\"  Savings Rate: {(savings / (total_cost or 1) * 100):.1f}%\")\n\n        print(\"=\" * 70)\n\n    # Override workflow methods to add pauses\n\n    def initialize_workflow(self, state: PRPState) -> PRPState:\n        \"\"\"Initialize workflow with pause.\"\"\"\n        self.pause_for_user(\"Initializing Workflow\", state)\n\n        print(\"\\nüîÑ Running initialization logic...\")\n        print(\"  - Creating workflow ID\")\n        print(\"  - Setting up state tracking\")\n        print(\"  - Loading configuration\")\n\n        result = super().initialize_workflow(state)\n\n        print(\"\\n‚úÖ Initialization complete\")\n        return result\n\n    def validate_gate_2(self, state: PRPState) -> PRPState:\n        \"\"\"Validate Gate 2 with pause.\"\"\"\n        self.pause_for_user(\"Validating Gate 2: Test Coverage\", state)\n\n        print(\"\\nüîç Gate 2 Validation:\")\n        print(\"  - Running pytest --cov\")\n        print(\"  - Checking coverage threshold (100%)\")\n        print(\"  - Validating no mocks in src/\")\n\n        result = super().validate_gate_2(state)\n\n        # Show result\n        validation = result.get('current_validation_result', {})\n        if validation.get('passed'):\n            print(\"\\n‚úÖ Gate 2 PASSED\")\n            print(f\"  Coverage: {validation.get('details', {}).get('coverage_percentage', 'N/A')}%\")\n        else:\n            print(\"\\n‚ùå Gate 2 FAILED\")\n            print(f\"  Reason: {validation.get('message', 'Unknown')}\")\n\n        return result\n\n    def handle_failure(self, state: PRPState) -> PRPState:\n        \"\"\"Handle failure with pause.\"\"\"\n        self.pause_for_user(\"Handling Gate Failure\", state)\n\n        print(\"\\n‚ö†Ô∏è  Gate failure detected\")\n        print(f\"  Consecutive failures: {state.get('consecutive_failures', 0)}\")\n\n        current_gate = state.get('current_gate', 'unknown')\n        retry_count = state.get('gates_failed', {}).get(current_gate, 0)\n\n        if retry_count >= 3:\n            print(\"\\nüßë‚Äçüíº Consulting specialist agent (3-strike rule)\")\n            print(f\"  Specialist: {self._get_specialist_for_gate(current_gate)}\")\n        else:\n            print(f\"\\nüîÑ Preparing retry #{retry_count + 1}\")\n\n        result = super().handle_failure(state)\n        return result\n\n    def workflow_success(self, state: PRPState) -> PRPState:\n        \"\"\"Success node with pause.\"\"\"\n        self.pause_for_user(\"Workflow Success!\", state)\n\n        print(\"\\nüéâ All gates passed successfully!\")\n        print(f\"  Gates completed: {', '.join(state.get('gates_passed', []))}\")\n\n        result = super().workflow_success(state)\n        return result\n\n    def _get_specialist_for_gate(self, gate_id: str) -> str:\n        \"\"\"Get specialist agent name for gate.\"\"\"\n        mapping = {\n            \"gate_2_coverage\": \"test-automation\",\n            \"gate_3_mock\": \"test-automation\",\n            \"gate_4_contract\": \"api-designer\",\n            \"gate_5_security\": \"security-reviewer\",\n            \"gate_6_production_ready\": \"devops-engineer\"\n        }\n        return mapping.get(gate_id, \"general-purpose\")\n\n\ndef print_intro():\n    \"\"\"Print introduction message.\"\"\"\n    print(\"\\n\" + \"=\" * 70)\n    print(\" Interactive LangGraph Walkthrough\")\n    print(\"=\" * 70)\n    print(\"\\nWelcome to the hands-on LangGraph learning experience!\")\n    print(\"\\nThis walkthrough will:\")\n    print(\"  ‚Ä¢ Execute the PRP workflow step-by-step\")\n    print(\"  ‚Ä¢ Show you state changes in real-time\")\n    print(\"  ‚Ä¢ Demonstrate cost optimization via caching\")\n    print(\"  ‚Ä¢ Let you inspect state at any point\")\n    print(\"\\nYou'll see exactly how LangGraph manages state, retries, and costs.\")\n    print(\"\\nPress ENTER at each step to continue, or use commands:\")\n    print(\"  's' = Show full state object\")\n    print(\"  'c' = Show detailed cost breakdown\")\n    print(\"  'q' = Quit walkthrough\")\n    print(\"\\n\" + \"=\" * 70)\n    input(\"\\nPress ENTER to begin...\")\n\n\ndef print_summary(result: PRPState):\n    \"\"\"Print final summary.\"\"\"\n    print(\"\\n\" + \"=\" * 70)\n    print(\" Walkthrough Complete!\")\n    print(\"=\" * 70)\n\n    status = result.get('workflow_status', 'unknown')\n    print(f\"\\nFinal Status: {status.upper()}\")\n\n    gates_passed = result.get('gates_passed', [])\n    gates_failed = result.get('gates_failed', {})\n\n    print(f\"\\nüìä Gates Summary:\")\n    print(f\"  Passed: {len(gates_passed)}\")\n    print(f\"  Failed: {len(gates_failed)}\")\n\n    costs = result.get('cost_tracking', {})\n    total_cost = sum(costs.values())\n    print(f\"\\nüí∞ Final Costs:\")\n    print(f\"  Total: ${total_cost:.4f}\")\n\n    print(\"\\nüìö Next Steps:\")\n    print(\"  1. Review LEARNING_GUIDE.md for conceptual deep-dive\")\n    print(\"  2. Check docs/architecture_diagrams.md for visual flowcharts\")\n    print(\"  3. Compare to POC scripts in docs/POC_COMPARISON.md\")\n    print(\"  4. Try auto_detect_runner.py on a real project\")\n\n    print(\"\\n\" + \"=\" * 70)\n\n\ndef main():\n    \"\"\"Run interactive walkthrough.\"\"\"\n    print_intro()\n\n    # Create mock PRP file for demonstration\n    prp_dir = Path(\"./prp\")\n    prp_dir.mkdir(exist_ok=True)\n\n    demo_prp = prp_dir / \"demo_feature.md\"\n    demo_prp.write_text(\"\"\"# Demo Feature\n\n## Overview\nThis is a demo feature for the interactive walkthrough.\n\n## Implementation\n- Add new user authentication flow\n- Integrate with OAuth provider\n- Add unit tests with 100% coverage\n\"\"\")\n\n    print(f\"\\n‚úì Created demo PRP file: {demo_prp}\")\n\n    # Initialize interactive workflow\n    print(\"\\nüîß Initializing interactive workflow...\")\n    workflow = InteractiveWorkflow()\n\n    print(\"‚úì Workflow ready\")\n\n    # Execute workflow\n    print(\"\\n‚ñ∂Ô∏è  Starting workflow execution...\")\n    print(\"   (The workflow will pause at each step)\")\n\n    try:\n        result = workflow.execute(\n            prp_file=str(demo_prp),\n            initial_state={\n                \"project_path\": \".\",\n                \"project_name\": \"LangChangeWorkflows\",\n                \"project_type\": \"python\"\n            }\n        )\n\n        print_summary(result)\n\n    except KeyboardInterrupt:\n        print(\"\\n\\n‚ö†Ô∏è  Walkthrough interrupted by user\")\n        return 1\n    except Exception as e:\n        print(f\"\\n\\n‚ùå Error during walkthrough: {e}\")\n        import traceback\n        traceback.print_exc()\n        return 1\n\n    return 0\n\n\nif __name__ == \"__main__\":\n    sys.exit(main())\n"}}
