{"session_id":"f0d4fbc3-a5b1-443e-8264-7550e32cfe6a","transcript_path":"/home/thomas/.claude/projects/-home-thomas-Repositories-LangChangeWorkflows/f0d4fbc3-a5b1-443e-8264-7550e32cfe6a.jsonl","cwd":"/home/thomas/Repositories/LangChangeWorkflows","permission_mode":"acceptEdits","hook_event_name":"PreToolUse","tool_name":"Write","tool_input":{"file_path":"/home/thomas/Repositories/LangChangeWorkflows/CLAUDE.md","content":"# LangGraph PRP Workflow Orchestration\n\n## Overview\n\nThis repository implements LangGraph-based workflow orchestration for Product Requirements Proposal (PRP) execution. It provides cost-optimized, state-managed multi-agent coordination for complex development workflows with validation gates, retry logic, and circuit breakers.\n\n**Key Benefits:**\n- 30-50% cost reduction through context sharing and caching\n- Explicit state management for complex multi-gate workflows\n- Natural fit for multi-agent coordination\n- Built-in retry logic and circuit breaker patterns\n- Ephemeral state (session-only) aligns with privacy-first architecture\n\n## Architecture\n\n### Repository Structure\n\n```\nLangChangeWorkflows/\n├── langgraph/\n│   ├── workflows/\n│   │   └── base_prp_workflow.py          # Core 6-gate PRP execution\n│   ├── nodes/\n│   │   ├── gates/\n│   │   │   ├── gate1_tdd_verification.py\n│   │   │   ├── gate2_coverage.py         # Phase 0 POC\n│   │   │   ├── gate3_mock_detection.py\n│   │   │   ├── gate4_mutation.py\n│   │   │   ├── gate5_security.py\n│   │   │   └── gate6_production_ready.py\n│   │   ├── failure_handling/\n│   │   │   ├── retry_logic.py            # 3-strike rule\n│   │   │   ├── circuit_breaker.py        # 15-failure stop\n│   │   │   └── specialist_consultation.py\n│   │   └── common/\n│   │       ├── git_operations.py\n│   │       ├── pr_management.py\n│   │       └── ci_cd_polling.py\n│   ├── schemas/\n│   │   ├── prp_state.py                  # TypedDict for PRP state\n│   │   └── validation_result.py\n│   ├── utils/\n│   │   ├── context_optimizer.py          # Cost-saving context sharing\n│   │   ├── state_persistence.py          # Ephemeral state management\n│   │   └── agent_coordinator.py          # Multi-agent orchestration\n│   ├── config/\n│   │   ├── default_gates.yaml            # Base gate configuration\n│   │   ├── default_thresholds.yaml       # 100% coverage, 95% mutation\n│   │   └── agent_mapping.yaml            # Agent coordination rules\n│   └── README.md                          # Detailed usage documentation\n├── deploy/\n│   └── deploy-langgraph.sh               # Deployment to ~/.claude/\n├── tests/\n│   └── langgraph/                        # Test suite for workflows\n└── CLAUDE.md                              # This file\n```\n\n### Deployment Model\n\n**Global Installation** (`~/.claude/langgraph/`):\n- Base workflow infrastructure shared across all projects\n- Standard gate implementations (Gates 1-6)\n- Default configuration and thresholds\n- Core utilities for state management and cost optimization\n\n**Project-Specific Extensions** (`.claude/langgraph/`):\n- Custom gates for domain-specific validation\n- Override configurations for project requirements\n- Project-specific plugins\n- Extended workflow definitions\n\n## The 6 Validation Gates\n\n### Gate 1: TDD Cycle Verification\n**Requirement**: RED-GREEN-REFACTOR pattern must be followed\n**Validation**: Commit history analyzed for proper TDD sequence\n**Threshold**: RED commits must precede GREEN commits\n**Agent**: `test-automation`\n\n### Gate 2: Test Coverage (Phase 0 POC)\n**Requirement**: 100% coverage (lines, branches, functions, statements)\n**Validation**: Coverage reports analyzed for completeness\n**Threshold**: Coverage must be exactly 100%\n**Agent**: `test-automation`\n\n### Gate 3: Mock Detection\n**Requirement**: Zero mocks in production code (src/)\n**Validation**: Static analysis scans all production code\n**Threshold**: 0 mocks/stubs/test doubles in src/\n**Agent**: Language-specific developer agent\n\n### Gate 4: Mutation Testing\n**Requirement**: Mutation score ≥95%\n**Validation**: Mutation testing framework validates test effectiveness\n**Threshold**: Score must be ≥95%\n**Agent**: `test-automation`\n\n### Gate 5: Security Validation\n**Requirement**: Zero critical/high vulnerabilities\n**Validation**: Security scanning and compliance checks\n**Threshold**: 0 critical/high severity issues\n**Agent**: `security-reviewer`\n\n### Gate 6: Production-Ready Standards\n**Requirement**: Complete implementations, error handling, logging\n**Validation**: Stub detection, error handling coverage, TODO resolution\n**Threshold**: Perfect completeness score (100/100)\n**Agent**: `architect-reviewer`\n\n## State Management\n\n### PRP State Schema\n\n```python\nclass PRPState(TypedDict):\n    prp_file: str                              # Path to PRP file\n    phase: str                                 # draft, generate, execute\n    gates_passed: List[str]                    # Successful gate IDs\n    gates_failed: Dict[str, int]               # gate_name: retry_count\n    consecutive_failures: int                  # Circuit breaker counter\n    specialist_consultations: List[str]        # Consulted agents\n    pr_number: Optional[int]                   # GitHub PR number\n    ci_cd_checks: Dict[str, str]              # check_name: status\n    tdd_cycle: str                             # \"red\", \"green\", \"refactor\"\n    cost_tracking: Dict[str, float]           # Cost optimization metrics\n```\n\n## Extension Patterns\n\nThe infrastructure supports three extension patterns for project-specific customization:\n\n### 1. Inheritance Pattern\n\n**Global Base** (`~/.claude/langgraph/workflows/base_prp_workflow.py`):\n```python\nfrom langgraph.graph import StateGraph\nfrom typing import TypedDict\n\nclass BasePRPWorkflow:\n    def __init__(self, config_path: str = None):\n        self.config = self.load_config(config_path)\n        self.graph = self.build_graph()\n\n    def build_graph(self) -> StateGraph:\n        \"\"\"Override in subclass to add custom nodes/edges\"\"\"\n        workflow = StateGraph(BasePRPState)\n        workflow.add_node(\"gate_1_tdd\", self.validate_tdd)\n        workflow.add_node(\"gate_2_coverage\", self.validate_coverage)\n        # ... gates 3-6\n        return workflow\n```\n\n**Project Extension** (`.claude/langgraph/workflows/custom_prp_workflow.py`):\n```python\nfrom claude.langgraph.workflows.base_prp_workflow import BasePRPWorkflow\n\nclass CustomPRPWorkflow(BasePRPWorkflow):\n    def build_graph(self):\n        workflow = super().build_graph()\n        # Add custom gates\n        workflow.add_node(\"gate_7_custom\", self.validate_custom)\n        return workflow\n```\n\n### 2. Configuration-Driven Pattern\n\n**Global Config** (`~/.claude/langgraph/config/default_gates.yaml`):\n```yaml\ngates:\n  - id: gate_1_tdd\n    name: \"TDD Cycle Verification\"\n    enabled: true\n    blocking: true\n\n  - id: gate_2_coverage\n    name: \"Test Coverage\"\n    enabled: true\n    blocking: true\n    threshold: 100\n\nfailure_handling:\n  max_retries: 3\n  circuit_breaker_threshold: 15\n```\n\n**Project Override** (`.claude/langgraph/config/gates.yaml`):\n```yaml\nextends: \"~/.claude/langgraph/config/default_gates.yaml\"\n\ngates:\n  # Add custom gates\n  - id: gate_7_privacy\n    name: \"PII Zero-Knowledge Validation\"\n    enabled: true\n    blocking: true\n    agent: privacy-validator\n```\n\n### 3. Plugin Pattern\n\n**Base Workflow**:\n```python\nclass BasePRPWorkflow:\n    def load_plugins(self):\n        \"\"\"Auto-discover plugins from .claude/langgraph/plugins/\"\"\"\n        plugin_dir = Path(\".claude/langgraph/plugins\")\n        if plugin_dir.exists():\n            for plugin_file in plugin_dir.glob(\"*.py\"):\n                module = import_module(f\".claude.langgraph.plugins.{plugin_file.stem}\")\n                self.plugins.append(module.Plugin())\n```\n\n**Project Plugin** (`.claude/langgraph/plugins/custom_gate.py`):\n```python\nclass Plugin:\n    def register_nodes(self, workflow: StateGraph):\n        workflow.add_node(\"gate_7_custom\", self.validate_custom)\n        workflow.add_conditional_edges(\n            \"gate_6_production_ready\",\n            lambda state: \"gate_7_custom\" if \"gate_6\" in state[\"gates_passed\"]\n                         else \"handle_failure\"\n        )\n```\n\n## Cost Optimization\n\n### Current Approach Costs (Estimated)\n```\nDraft phase:    1 Claude API call    (~2K tokens)     $0.03\nGenerate phase: 3 Claude API calls   (~15K tokens)    $0.23\nExecute phase:  12 calls (6 gates)   (~30K tokens)    $0.44\n────────────────────────────────────────────────────────────\nTotal per PRP:                        ~47K tokens      $0.70\n```\n\n### LangGraph Optimization\n```\nDraft phase:    1 call               (~2K tokens)     $0.03\nGenerate phase: 1 call (shared ctx)  (~8K tokens)     $0.12 (47% savings)\nExecute phase:  Cached + shared ctx  (~18K tokens)    $0.27 (40% savings)\n────────────────────────────────────────────────────────────────────────────\nTotal per PRP:                        ~28K tokens      $0.42 (40% savings)\n```\n\n**ROI Analysis:**\n- Savings per PRP: $0.28 (40%)\n- 100 PRPs: $28 saved\n- 1,000 PRPs: $280 saved\n- Implementation cost: ~8 hours ($800 one-time)\n- Payback threshold: ~2,857 PRPs\n\n## Failure Handling\n\n### Retry Logic (3-Strike Rule)\n- Each gate allows up to 3 failures before escalation\n- After 3 failures, specialist agent consulted\n- Specialist provides remediation guidance\n- State tracks retry counts per gate\n\n### Circuit Breaker (15-Failure Stop)\n- Consecutive failures tracked across all gates\n- At 15 consecutive failures, workflow halts\n- Manual intervention required\n- Complete audit trail generated\n\n### Specialist Consultation\nFailure-specific agents consulted after 3-strike threshold:\n- Gate 1 (TDD): `test-automation`\n- Gate 2 (Coverage): `test-automation`\n- Gate 3 (Mocks): Language-specific developer\n- Gate 4 (Mutation): `test-automation`\n- Gate 5 (Security): `security-reviewer`\n- Gate 6 (Production-Ready): `architect-reviewer`\n\n## Integration with Existing Infrastructure\n\n### ArgoCD Relationship\n- **ArgoCD**: Infrastructure deployment (GitOps: sync from Git to K8s)\n- **LangGraph**: Application-level PRP workflow orchestration\n- **No conflict**: Different layers, complementary purposes\n\n### ClaudeAgents Repository\nThis LangGraph infrastructure integrates with the ClaudeAgents meta-repository:\n```\nClaudeAgents/\n├── agents/                 # 206+ specialized agents\n├── commands/               # Slash commands (draft-prp, generate-prp, execute-prp)\n├── langgraph/              # NEW: LangGraph workflows\n└── deploy/\n    └── update-project.sh   # Deploys agents + LangGraph to ~/.claude/\n```\n\n### Slash Command Integration\n\n**Current Commands:**\n- `/draft-prp [description]` - Create draft PRP\n- `/generate-prp [draft-file]` - Generate complete PRP\n- `/execute-prp [prp-file]` - Execute PRP with validation gates\n\n**LangGraph Integration:**\nThese commands will be updated to use LangGraph workflows for:\n- State management across workflow phases\n- Cost-optimized multi-agent coordination\n- Retry logic and failure handling\n- Complete audit trail\n\n## Phase 0: Proof of Concept\n\n### Scope\n- Implement Gate 2 (Coverage validation) only\n- Validate LangGraph architecture\n- Measure cost savings\n- Test extension patterns\n- Confirm state persistence\n\n### Success Criteria\n✅ Gate 2 validation functional in LangGraph\n✅ Measurable 30-40% cost reduction\n✅ All 3 extension patterns working\n✅ Successful deployment to `~/.claude/langgraph/`\n✅ Project-specific override validated\n\n### Deliverables\n1. Working Gate 2 implementation\n2. Cost analysis comparison\n3. Extension pattern examples\n4. Deployment documentation\n5. Recommendation for full implementation\n\n## Deployment\n\n### Global Installation\n\n```bash\n# From ClaudeAgents repository\ncd ClaudeAgents\n./deploy/update-project.sh --langgraph\n\n# Deploys to:\n# ~/.claude/langgraph/\n```\n\n### Project-Specific Customization\n\n```bash\n# In your project\nmkdir -p .claude/langgraph/workflows\nmkdir -p .claude/langgraph/nodes/custom_gates\nmkdir -p .claude/langgraph/config\n\n# Create custom workflow extending base\n# Create custom gates as needed\n# Override configuration in .claude/langgraph/config/gates.yaml\n```\n\n### Update Command Integration\n\nThe `/update-project` slash command will be extended to deploy LangGraph:\n```bash\n/update-project --langgraph     # Deploy LangGraph infrastructure\n/update-project --full-refresh  # Deploy everything including LangGraph\n```\n\n## Future Roadmap\n\n### Phase 1: Core Workflow (3-5 days)\n- Implement all 6 gates in LangGraph\n- Add TDD cycle nodes (RED-GREEN-REFACTOR)\n- Complete retry logic and circuit breaker\n- Full multi-agent validation\n\n### Phase 2: Slash Command Integration (2-3 days)\n- Wrap LangGraph in /execute-prp\n- Update /generate-prp for multi-agent coordination\n- State inspection commands\n- Debug utilities\n\n### Phase 3: Optimization & Monitoring (2-3 days)\n- Fine-tune caching strategies\n- Optimize context sharing\n- Parallel execution where safe\n- Metrics and observability\n\n### Phase 4: Documentation & Training (1-2 days)\n- Complete workflow documentation\n- Architecture diagrams\n- Troubleshooting guides\n- Migration guides for existing projects\n\n## Dependencies\n\n### Required Packages\n```\nlanggraph>=0.0.1\nanthropic>=0.7.0\npydantic>=2.0.0\npyyaml>=6.0\n```\n\n### Python Version\n- Python 3.10+\n\n### Environment\n- Claude API key configured\n- Git repository with proper branch structure\n- CI/CD pipeline (optional but recommended)\n\n## Testing\n\n### Test Coverage Requirements\n- 100% coverage for all LangGraph workflows\n- Integration tests for each gate\n- State persistence tests\n- Cost tracking validation\n- Extension pattern tests\n\n### Test Structure\n```\ntests/langgraph/\n├── test_workflows/\n│   └── test_base_prp_workflow.py\n├── test_nodes/\n│   └── test_gate2_coverage.py\n├── test_schemas/\n│   └── test_prp_state.py\n└── test_extension_patterns/\n    ├── test_inheritance.py\n    ├── test_config_driven.py\n    └── test_plugins.py\n```\n\n## Security Considerations\n\n### State Management Security\n- Ephemeral state only (no persistence to disk)\n- Sensitive data redacted from logs\n- API keys managed via environment variables\n- No PII stored in workflow state\n\n### Gate Validation Security\n- Security gate (Gate 5) is non-bypassable\n- All external tool calls validated\n- Subprocess execution sandboxed\n- Audit trail for all gate decisions\n\n## Troubleshooting\n\n### Common Issues\n\n**Issue: Gate keeps failing**\n- Check retry count in state\n- Review specialist consultation logs\n- Verify threshold configuration\n- Check for circuit breaker activation\n\n**Issue: Cost not optimizing**\n- Verify context sharing enabled\n- Check cache hit rates\n- Review agent coordination logic\n- Validate state persistence\n\n**Issue: Extension not loading**\n- Check file paths and imports\n- Verify plugin registration\n- Review configuration extends syntax\n- Check for naming conflicts\n\n## Support\n\n### Documentation\n- Full documentation: `langgraph/README.md`\n- Architecture diagrams: `docs/architecture/`\n- Extension examples: `examples/`\n\n### Issue Tracking\n- Report issues to ClaudeAgents repository\n- Tag with `langgraph` label\n- Include workflow state snapshot\n- Attach cost tracking metrics\n\n## Version\n\n**Current Version**: 0.1.0 (Phase 0 POC)\n**Status**: Proof of Concept\n**Target**: Gate 2 (Coverage) validation\n\n---\n\n*This LangGraph infrastructure is part of the ClaudeAgents meta-repository and follows all global orchestration rules defined in `~/.claude/CLAUDE.md`*\n"}}
